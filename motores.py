# Configura칞칚o da p치gina
# cd C:\Users\Usu치rio\Documents
# streamlit run motores.py
import streamlit as st
import pandas as pd
import sqlite3
import hashlib
from datetime import datetime

# Configura칞칚o do banco de dados
USER_DB = "users.db"

def init_db():
    conn = sqlite3.connect(USER_DB)
    c = conn.cursor()
    
    # Tabela de usu치rios
    c.execute('''CREATE TABLE IF NOT EXISTS users
                 (id INTEGER PRIMARY KEY AUTOINCREMENT,
                 username TEXT UNIQUE NOT NULL,
                 password_hash TEXT NOT NULL,
                 full_name TEXT,
                 email TEXT,
                 role TEXT NOT NULL,
                 is_active INTEGER DEFAULT 1,
                 created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP)''')
    
    # Tabela de logs de acesso
    c.execute('''CREATE TABLE IF NOT EXISTS access_logs
                 (id INTEGER PRIMARY KEY AUTOINCREMENT,
                 user_id INTEGER,
                 login_time TIMESTAMP,
                 logout_time TIMESTAMP,
                 ip_address TEXT,
                 success INTEGER,
                 FOREIGN KEY(user_id) REFERENCES users(id))''')
    
    # Inserir usu치rio admin padr칚o se n칚o existir
    try:
        admin_hash = hashlib.sha256("admin123".encode()).hexdigest()
        c.execute("INSERT INTO users (username, password_hash, role) VALUES (?, ?, ?)",
                  ("admin", admin_hash, "admin"))
    except sqlite3.IntegrityError:
        pass
    
    conn.commit()
    conn.close()

init_db()

def authenticate_user(username, password):
    conn = sqlite3.connect(USER_DB)
    c = conn.cursor()
    
    c.execute("SELECT id, password_hash, role, is_active FROM users WHERE username = ?", (username,))
    user = c.fetchone()
    conn.close()
    
    if not user:
        return None, "Usu치rio n칚o encontrado"
    
    if not user[3]:  # is_active
        return None, "Usu치rio desativado"
    
    hashed_input = hashlib.sha256(password.encode()).hexdigest()
    if hashed_input == user[1]:
        return {"id": user[0], "username": username, "role": user[2]}, None
    else:
        return None, "Senha incorreta"

def login_component():
    if 'user' not in st.session_state:
        st.session_state.user = None
        st.session_state.login_attempts = 0
        st.session_state.last_attempt = None
    
    if st.session_state.user:
        return True
    
    with st.container(border=True):
        st.markdown("### Acesso ao Sistema")
        
        if (st.session_state.login_attempts >= 3 and 
            (datetime.now() - st.session_state.last_attempt).seconds < 300):
            st.error("Muitas tentativas falhas. Tente novamente em 5 minutos.")
            return False
        
        username = st.text_input("Usu치rio")
        password = st.text_input("Senha", type="password")
        
        if st.button("Entrar"):
            user, error = authenticate_user(username, password)
            if user:
                st.session_state.user = user
                log_access(user['id'], True)
                st.rerun()
            else:
                st.session_state.login_attempts += 1
                st.session_state.last_attempt = datetime.now()
                log_access(None, False, username)
                st.error(f"Falha no login: {error}")
    
    return False

def user_management():
    if not (st.session_state.user and st.session_state.user['role'] == 'admin'):
        st.warning("Acesso restrito a administradores")
        return
    
    st.title("Gerenciamento de Usu치rios")
    
    tab1, tab2, tab3 = st.tabs(["Adicionar Usu치rio", "Listar Usu치rios", "Editar Usu치rios"])
    
    with tab1:
        with st.form("add_user_form"):
            st.write("### Cadastrar Novo Usu치rio")
            new_username = st.text_input("Nome de usu치rio*")
            new_password = st.text_input("Senha*", type="password")
            full_name = st.text_input("Nome completo")
            email = st.text_input("Email")
            role = st.selectbox("Perfil*", ["operador", "supervisor", "admin"])
            
            if st.form_submit_button("Cadastrar"):
                if not new_username or not new_password:
                    st.error("Campos obrigat칩rios marcados com *")
                else:
                    try:
                        conn = sqlite3.connect(USER_DB)
                        c = conn.cursor()
                        hashed_pw = hashlib.sha256(new_password.encode()).hexdigest()
                        c.execute("INSERT INTO users (username, password_hash, full_name, email, role) VALUES (?, ?, ?, ?, ?)",
                                  (new_username, hashed_pw, full_name, email, role))
                        conn.commit()
                        st.success(f"Usu치rio {new_username} cadastrado com sucesso!")
                    except sqlite3.IntegrityError:
                        st.error("Nome de usu치rio j치 existe")
                    finally:
                        conn.close()
    
    with tab2:
        conn = sqlite3.connect(USER_DB)
        users = pd.read_sql("SELECT id, username, full_name, role, is_active FROM users", conn)
        conn.close()
        
        st.dataframe(users, use_container_width=True,
                    column_config={
                        "is_active": st.column_config.CheckboxColumn("Ativo"),
                        "id": None
                    },
                    hide_index=True)
    
    with tab3:
        conn = sqlite3.connect(USER_DB)
        users = pd.read_sql("SELECT id, username, role, is_active FROM users", conn)
        conn.close()
        
        selected_user = st.selectbox("Selecionar usu치rio", 
                                   users['username'],
                                   index=None)
        
        if selected_user:
            user_data = users[users['username'] == selected_user].iloc[0]
            
            with st.form("edit_user_form"):
                st.write(f"Editando: {selected_user}")
                new_role = st.selectbox("Perfil", ["operador", "supervisor", "admin"], 
                                      index=["operador", "supervisor", "admin"].index(user_data['role']))
                is_active = st.checkbox("Ativo", value=bool(user_data['is_active']))
                new_password = st.text_input("Nova senha (deixe em branco para manter)", type="password")
                
                if st.form_submit_button("Salvar altera칞칫es"):
                    conn = sqlite3.connect(USER_DB)
                    c = conn.cursor()
                    
                    if new_password:
                        hashed_pw = hashlib.sha256(new_password.encode()).hexdigest()
                        c.execute("UPDATE users SET role = ?, is_active = ?, password_hash = ? WHERE id = ?",
                                (new_role, int(is_active), hashed_pw, user_data['id']))
                    else:
                        c.execute("UPDATE users SET role = ?, is_active = ? WHERE id = ?",
                                (new_role, int(is_active), user_data['id']))
                    
                    conn.commit()
                    conn.close()
                    st.success("Altera칞칫es salvas!")

def main_app():
    if not login_component():
        st.stop()
    
    # Barra lateral com informa칞칫es do usu치rio
    with st.sidebar:
        st.markdown(f"### 游녻 {st.session_state.user['username']}")
        st.markdown(f"**Perfil:** {st.session_state.user['role']}")
        
        if st.button("游댃 Atualizar Dados"):
            st.cache_data.clear()
            st.rerun()
            
        if st.button("游뛁 Sair"):
            log_logout(st.session_state.user['id'])
            del st.session_state.user
            st.rerun()
        
        # Mostrar gerenciamento de usu치rios apenas para admin
        if st.session_state.user['role'] == 'admin':
            if st.toggle("Mostrar Gerenciamento"):
                user_management()
                st.stop()
    
# Configura칞칫es de seguran칞a
PASSWORD = "kepla321"  # Troque por uma senha complexa
MAX_ATTEMPTS = 3
LOG_FILE = "access_log.txt"

# Verifica칞칚o de senha
def check_password():
    if 'authenticated' not in st.session_state:
        st.session_state.authenticated = False
        st.session_state.attempts = 0
    
    if not st.session_state.authenticated:
        password = st.text_input("Digite a senha de acesso:", type="password")
        
        if st.button("Acessar"):
            if password == PASSWORD:
                st.session_state.authenticated = True
                log_access(True)
                st.rerun()
            else:
                st.session_state.attempts += 1
                log_access(False)
                if st.session_state.attempts >= MAX_ATTEMPTS:
                    st.error("N칰mero m치ximo de tentativas excedido")
                    st.stop()
                else:
                    st.error(f"Senha incorreta. Tentativas restantes: {MAX_ATTEMPTS - st.session_state.attempts}")
        st.stop()

# Log de acesso
def log_access(success):
    with open(LOG_FILE, "a") as f:
        f.write(f"{datetime.now()} - {'SUCCESS' if success else 'FAILED'} - {st.experimental_get_query_params().get('client', ['unknown'])[0]}\n")

# Seu c칩digo original (adaptado)
def main_app():
    st.set_page_config(
            page_title="Cat치logo de Motores - Busca por TAG",
            layout="wide",
        )

    @st.cache_data
    def load_data():

            try:
                # ATEN칂츾O: Substitua pelo caminho correto do seu arquivo
                return pd.read_excel(r"C:\Users\Usu치rio\Documents\motores.xlsx")
            except FileNotFoundError:
                st.error("Arquivo 'motores.xlsx' n칚o encontrado. Verifique o caminho.")
                return pd.DataFrame()
            except Exception as e:
                st.error(f"Erro ao carregar dados: {str(e)}")
                return pd.DataFrame()

        # Carrega os dados
    df = load_data()

    if not df.empty:
            # --- BUSCA POR TAG ---
            st.title("Motores El칠tricos")
            
            # Campo de busca por digita칞칚o
            search_term = st.text_input(
                "Digite a POSI칂츾O do motor:",
                placeholder="Comece a digitar a POSI칂츾O...",
                key="tag_search"
            )
            
            try:
                # Filtra as op칞칫es com base no que foi digitado
                if search_term:
                    mask = df["TAG ATUAL"].astype(str).str.contains(str(search_term), case=False, na=False)
                    filtered_tags = df.loc[mask, "TAG ATUAL"].unique()
                else:
                    filtered_tags = df["TAG ATUAL"].unique()
                
                # Verifica se h치 resultados
                if len(filtered_tags) == 0:
                    st.warning("Nenhum motor encontrado com esta POSI칂츾O")
                    st.stop()
                    
                # Selecionador de TAG com as op칞칫es filtradas
                selected_tag = st.selectbox(
                    "Ou selecione a POSI칂츾O do motor:",
                    options=filtered_tags,
                    index=0
                )
                
                # Filtra os dados
                motor_data = df[df["TAG ATUAL"] == selected_tag].iloc[0]
                
            except Exception as e: 
                st.error(f"Erro ao filtrar dados: {str(e)}")
                st.stop()
            
            # --- EXIBI칂츾O DOS DADOS ---
            st.markdown("---")
            st.subheader(f"Dados T칠cnicos - {selected_tag}")
            
            # Organiza칞칚o em abas (mantido igual)
            tab1, tab2, tab3 = st.tabs(["Informa칞칫es B치sicas", "Especifica칞칫es T칠cnicas", "Detalhes Mec칙nicos"])
            
            with tab1:
                col1, col2 = st.columns(2)
                with col1:
                    st.markdown(f"""
                    **TAG Ativo:** {motor_data["TAG ATIVO"]}  
                    **Descri칞칚o:** {motor_data["DESCRI칂츾O"]}  
                    **Localiza칞칚o:** {motor_data["LOCAL"]}  
                    **츼rea de Instala칞칚o:** {motor_data["츼REA"]}  
                    """)
                with col2:
                    st.markdown(f"""
                    **Fabricante:** {motor_data["FABRICANTE"]}  
                    **Modelo:** {motor_data["MODELO"]}  
                    **N춿 S칠rie:** {motor_data["N춿 DE S칄RIE"]}  
                    **Ano Fabrica칞칚o:** {motor_data["ANO FAB."]}  
                    """)
            
            with tab2:
                col1, col2 = st.columns(2)
                with col1:
                    st.markdown(f"""
                    **Pot칡ncia:** {motor_data["POT칅NCIA (kW)"]} kW  
                    **Tens칚o:** {motor_data["TENS츾O (V)"]} V  
                    **Corrente:** {motor_data["CORRENTE(A)"]} A  
                    **Frequ칡ncia:** {motor_data["FREQ.(Hz)"]} Hz  
                    """)
                with col2:
                    st.markdown(f"""
                    **N춿 Fases:** {motor_data["N췈 DE FASES"]}  
                    **N춿 Polos:** {motor_data["N춿 POLOS"]}  
                    **RPM:** {motor_data["RPM"]}  
                    **Grau IP:** {motor_data["GRAU IP"]}  
                    """)
            
            with tab3:
                col1, col2 = st.columns(2)
                with col1:
                    st.markdown(f"""
                    **Carca칞a:** {motor_data["CARCA칂A"]}  
                    **Peso:** {motor_data["PESO (kg)"]} kg  
                    **Posi칞칚o Instala칞칚o:** {motor_data["POSI칂츾O DE INSTALA칂츾O"]}  
                    """)
                with col2:
                    st.markdown(f"""
                    **Rolamento Dianteiro:** {motor_data["ROLAMENTO DIANTEIRO"]}  
                    **Rolamento Traseiro:** {motor_data["ROLAMENTO TRASEIRO"]}  
                    **Tipo Graxa:** {motor_data["GRAXA TIPO"]}  
                    """)
            
            # Bot칚o para mostrar todos os dados (opcional)
            if st.button("Mostrar todos os dados brutos"):
                st.write(motor_data)

    else:
            st.warning("Nenhum dado foi carregado. Verifique o arquivo de origem.")

        # Rodap칠
    st.markdown("---")
    st.caption("Sistema de Cat치logo de Motores - 춸 2025")
    pass

# Fluxo principal
check_password()
main_app()

def log_access(user_id, success, username=None):
    conn = sqlite3.connect(USER_DB)
    c = conn.cursor()
    
    ip = st.experimental_get_query_params().get('client', ['unknown'])[0]
    
    if success:
        c.execute("INSERT INTO access_logs (user_id, login_time, ip_address, success) VALUES (?, ?, ?, ?)",
                 (user_id, datetime.now(), ip, 1))
    else:
        c.execute("INSERT INTO access_logs (login_time, ip_address, success) VALUES (?, ?, ?)",
                 (datetime.now(), ip, 0))
    
    conn.commit()
    conn.close()

def log_logout(user_id):
    conn = sqlite3.connect(USER_DB)
    c = conn.cursor()
    
    # Atualiza o 칰ltimo registro de login com o hor치rio de logout
    c.execute('''UPDATE access_logs SET logout_time = ?
                WHERE user_id = ? AND logout_time IS NULL
                ORDER BY login_time DESC LIMIT 1''',
             (datetime.now(), user_id))
    
    conn.commit()
    conn.close()
